name: Test Charm

on:
  push:
    branches: [ main, master ]
    paths:
      - 'charm/**'
      - 'server/**'
      - 'client/**'
      - '.github/workflows/test.yaml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'charm/**'
      - 'server/**'
      - 'client/**'
      - '.github/workflows/test.yaml'
  workflow_dispatch:

jobs:
  lint:
    name: Lint Python Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: '3.10'
      
      - name: Install dependencies
        working-directory: charm
        run: |
          uv pip install flake8 black isort
          uv pip install -r requirements.txt
      
      - name: Run flake8
        working-directory: charm
        run: uv run flake8 src/ tests/ --max-line-length=100 --ignore=E203,W503
      
      - name: Check code formatting with black
        working-directory: charm
        run: uv run black --check src/ tests/
      
      - name: Check import sorting with isort
        working-directory: charm
        run: uv run isort --check-only src/ tests/

  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: '3.10'
      
      - name: Install dependencies
        working-directory: charm
        run: |
          uv pip install -r requirements.txt
          uv pip install coverage pytest
      
      - name: Run unit tests with coverage
        working-directory: charm
        run: |
          export PYTHONPATH="${PYTHONPATH}:${PWD}/src"
          uv run coverage run -m pytest tests/
          uv run coverage report -m
          uv run coverage xml
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./charm/coverage.xml
          flags: unittests
          name: charm-coverage

  build-rust:
    name: Build Rust Binaries
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
      
      - name: Build webhook-relay server
        run: cargo build --release --manifest-path=server/Cargo.toml
      
      - name: Build relayd client
        run: cargo build --release --manifest-path=client/Cargo.toml
      
      - name: Upload binaries as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rust-binaries
          path: |
            target/release/webhook-relay
            target/release/relayd

  pack-charm:
    name: Pack Charm
    runs-on: ubuntu-latest
    needs: [lint, unit-test, build-rust]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup LXD
        uses: canonical/setup-lxd@main
      
      - name: Install charmcraft
        run: sudo snap install charmcraft --classic
      
      - name: Download Rust binaries
        uses: actions/download-artifact@v4
        with:
          name: rust-binaries
          path: target/release/
      
      - name: Make binaries executable
        run: |
          chmod +x target/release/webhook-relay
          chmod +x target/release/relayd
      
      - name: Create bin directory in charm
        run: mkdir -p charm/bin
      
      - name: Copy binaries to charm
        run: |
          cp target/release/webhook-relay charm/bin/
          cp target/release/relayd charm/bin/
      
      - name: Pack charm
        working-directory: charm
        run: charmcraft pack
      
      - name: Upload charm artifact
        uses: actions/upload-artifact@v4
        with:
          name: webhook-relay-charm
          path: charm/*.charm

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [pack-charm]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup LXD
        uses: canonical/setup-lxd@v1
        with:
          channel: 5.21/stable
      
      - name: Configure LXD IPv6
        run: |
          lxc network set lxdbr0 ipv6.address none
          lxc network set lxdbr0 ipv6.dhcp false
          lxc network set lxdbr0 ipv6.nat false
      
      - name: Install Juju
        run: sudo snap install juju --channel 3.6/stable
      
      - name: Bootstrap Juju
        run: juju bootstrap localhost test-controller --config test-mode=true
      
      - name: Add Juju model
        run: juju add-model test-model
      
      - name: Download charm
        uses: actions/download-artifact@v4
        with:
          name: webhook-relay-charm
          path: charm/
      
      - name: Deploy charm in webhook mode
        run: |
          juju deploy ./charm/*.charm webhook-relay --config mode=server --config port=3000
          juju wait-for application webhook-relay --timeout=10m
      
      - name: Test webhook mode status
        run: |
          juju status webhook-relay
          juju exec --unit webhook-relay/0 -- systemctl status webhook-relay
      
      - name: Deploy charm in relayd mode
        run: |
          juju deploy ./charm/*.charm relay-client --config mode=client --config url=http://test.example.com/test
          juju wait-for application relay-client --timeout=10m
      
      - name: Test relayd mode status
        run: |
          juju status relay-client
          juju exec --unit relay-client/0 -- systemctl status webhook-relay
      
      - name: Show logs on failure
        if: failure()
        run: |
          juju debug-log --replay --no-tail
          juju status

  functional-test:
    name: Functional Tests (Forwarding)
    runs-on: ubuntu-latest
    needs: [build-rust]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Rust binaries
        uses: actions/download-artifact@v4
        with:
          name: rust-binaries
          path: target/release/
      
      - name: Make binaries executable
        run: |
          chmod +x target/release/webhook-relay
          chmod +x target/release/relayd
      
      - name: Setup test environment
        run: |
          mkdir -p /tmp/webhook-test/secret
          CHANNEL_ID=$(echo -n "test-channel" | sha1sum | awk '{print $1}')
          echo -n "test-secret-123" > /tmp/webhook-test/secret/$CHANNEL_ID
          echo "CHANNEL_ID=$CHANNEL_ID" >> $GITHUB_ENV
          echo "Test environment ready with channel: $CHANNEL_ID"
      
      - name: Start webhook server
        run: |
          cd /tmp/webhook-test
          PORT=3000 HOST=127.0.0.1 PING_INTERVAL_MS=3000 \
            $GITHUB_WORKSPACE/target/release/webhook-relay > server.log 2>&1 &
          echo $! > server.pid
          sleep 2
          echo "Webhook server started"
      
      - name: Start HTTP receiver
        run: |
          python3 -c "
          import http.server
          import socketserver
          import json
          from datetime import datetime
          
          class Handler(http.server.BaseHTTPRequestHandler):
              def do_POST(self):
                  length = int(self.headers.get('Content-Length', 0))
                  data = self.rfile.read(length)
                  timestamp = datetime.now().strftime('%H:%M:%S.%f')[:-3]
                  print(f'[{timestamp}] RECEIVED: {data.decode(\"utf-8\")}', flush=True)
                  self.send_response(200)
                  self.send_header('Content-type', 'text/plain')
                  self.end_headers()
                  self.wfile.write(b'OK')
              def log_message(self, format, *args):
                  pass
          
          print('Receiver ready on port 8888', flush=True)
          with socketserver.TCPServer(('127.0.0.1', 8888), Handler) as httpd:
              httpd.serve_forever()
          " > /tmp/receiver.log 2>&1 &
          echo $! > /tmp/receiver.pid
          sleep 2
          echo "HTTP receiver started"
      
      - name: Start relayd with forwarding
        run: |
          RUST_LOG=info $GITHUB_WORKSPACE/target/release/relayd \
            "http://127.0.0.1:3000/${{ env.CHANNEL_ID }}" \
            /dev/null \
            http://127.0.0.1:8888/webhook > /tmp/relayd.log 2>&1 &
          echo $! > /tmp/relayd.pid
          sleep 3
          echo "Relayd started with forwarding"
      
      - name: Test webhook forwarding
        run: |
          # Send test webhook
          PAYLOAD='{"test":"ci_webhook","message":"Testing forwarding","timestamp":'$(date +%s)'}'
          SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha1 -hmac "test-secret-123" | awk '{print $2}')
          
          echo "Sending webhook to channel: ${{ env.CHANNEL_ID }}"
          curl -X POST "http://127.0.0.1:3000/${{ env.CHANNEL_ID }}" \
            -H "Content-Type: application/json" \
            -H "X-Hub-Signature: sha1=$SIGNATURE" \
            -d "$PAYLOAD"
          
          sleep 2
          
          # Verify webhook was forwarded
          if grep -q "RECEIVED.*ci_webhook" /tmp/receiver.log; then
            echo "✅ Webhook successfully forwarded"
          else
            echo "❌ Webhook was NOT forwarded"
            exit 1
          fi
          
          # Verify relayd logged the forward
          if grep -q "Successfully forwarded payload" /tmp/relayd.log; then
            echo "✅ Relayd confirmed forwarding"
          else
            echo "❌ Relayd did not confirm forwarding"
            exit 1
          fi
      
      - name: Test ping event filtering
        run: |
          # Get initial receiver log size
          INITIAL_SIZE=$(wc -l < /tmp/receiver.log)
          
          echo "Waiting 6 seconds for ping events (interval: 3s)..."
          sleep 6
          
          # Check if receiver got any ping events (it should NOT)
          FINAL_SIZE=$(wc -l < /tmp/receiver.log)
          if [ "$FINAL_SIZE" -eq "$INITIAL_SIZE" ]; then
            echo "✅ Ping events were NOT forwarded (correct behavior)"
          else
            echo "❌ Receiver log changed during ping period:"
            tail -10 /tmp/receiver.log
            exit 1
          fi
          
          # Verify relayd received pings
          if grep -q "ping" /tmp/relayd.log || grep -q "heartbeat" /tmp/relayd.log; then
            echo "✅ Relayd received ping events but did not forward them"
          else
            echo "⚠️  Warning: No ping events detected in relayd log"
          fi
      
      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Webhook Server Log ==="
          cat /tmp/webhook-test/server.log || echo "No server log"
          echo ""
          echo "=== Relayd Log ==="
          cat /tmp/relayd.log || echo "No relayd log"
          echo ""
          echo "=== Receiver Log ==="
          cat /tmp/receiver.log || echo "No receiver log"
      
      - name: Cleanup
        if: always()
        run: |
          [ -f /tmp/relayd.pid ] && kill $(cat /tmp/relayd.pid) 2>/dev/null || true
          [ -f /tmp/receiver.pid ] && kill $(cat /tmp/receiver.pid) 2>/dev/null || true
          [ -f /tmp/webhook-test/server.pid ] && kill $(cat /tmp/webhook-test/server.pid) 2>/dev/null || true
